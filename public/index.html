<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BDI Blocks World</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <button class="hamburger" id="mobileMenuToggle" aria-label="Toggle navigation menu" aria-expanded="false"
      aria-controls="mobileMenu">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </button>
    <div class="mobile-brand" id="mobileBrand">BDI Blocks World</div>
    <div></div> <!-- Spacer for centering brand -->
  </div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <!-- Mobile Menu -->
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <div class="brand" id="mobileMenuBrand">BDI Blocks World</div>
      <button class="mobile-menu-close" id="mobileMenuClose" aria-label="Close menu">&times;</button>
    </div>

    <nav class="page-nav">
      <a href="#" class="page-nav-item active" data-page="simulation">Simulation</a>
      <a href="#" class="page-nav-item" data-page="agent-logs">Agent Logs</a>
      <a href="#" class="page-nav-item" data-page="import-export">Import/Export</a>
      <a href="#" class="page-nav-item" data-page="profile">Profile</a>
    </nav>
  </div>

  <div class="app">
    <aside class="sidebar">
      <div class="brand" id="sidebarBrand">BDI Blocks World</div>

      <nav class="page-nav">
        <a href="#" class="page-nav-item active" data-page="simulation">Simulation</a>
        <a href="#" class="page-nav-item" data-page="agent-logs">Agent Logs</a>
        <a href="#" class="page-nav-item" data-page="import-export">Import/Export</a>
        <a href="#" class="page-nav-item" data-page="profile">Profile</a>
      </nav>

      <div class="help">
        <strong>Quick Help:</strong><br/>
        • Drag blocks to move them<br/>
        • Set goals like "on(A,B)"<br/>
        • Run BDI to see planning in action<br/>
        • Save/load different worlds
      </div>
    </aside>

    <main class="main">
      <div class="topbar">
        <h2 class="page-title" id="pageTitle">Simulation</h2>
        <div class="profile-dropdown">
          <button class="profile-btn" id="profileBtn" aria-label="Profile menu">
            <span id="userPill">Signed out</span>
            <svg class="dropdown-icon" width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
              <path d="M2 4l4 4 4-4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/>
            </svg>
          </button>
          <div class="profile-menu" id="profileMenu">
            <div class="profile-menu-header">
              <div class="profile-menu-username" id="profileMenuUsername">User</div>
              <div class="profile-menu-email" id="profileMenuEmail">user@example.com</div>
            </div>
            <hr class="profile-menu-divider">
            <a href="#" class="profile-menu-item" data-page="profile">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 8a3 3 0 100-6 3 3 0 000 6zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
              Profile
            </a>
            <button class="profile-menu-item" onclick="logout(); return false;">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M3 1h8a1 1 0 011 1v3h-2V3H4v10h6v-2h2v3a1 1 0 01-1 1H3a1 1 0 01-1-1V2a1 1 0 011-1zm9 5l4 4-4 4v-3H6V9h6V6z"/>
              </svg>
              Logout
            </button>
          </div>
        </div>
      </div>

      <div class="grid">
        <section class="card">
          <h3>Simulation Environment</h3>
          <div class="simwrap">
            <div id="world-wrapper" class="card-body world-wrapper-no-padding">
              <div id="world"></div>
            </div>
            <div id="messages" class="messages"></div>
          </div>
        </section>

        <section class="card">
          <h3>Control Panel</h3>
          <div class="card-body">
            <div class="controls-grid">
              <div class="form-group">
                <label for="blockName">Add block:</label>
                <input type="text" id="blockName" placeholder="Block name (e.g. A)" />
                <button id="addBlockBtn">Add Block</button>
              </div>

              <div class="form-group">
                <label for="goalInput">Goal stack:</label>
                <input type="text" id="goalInput" placeholder="e.g. A on C on D" />
                <button id="startBtn">Start Simulation</button>
              </div>
            </div>

            <hr class="divider">

            <div class="inline-controls">
              <button id="saveBtn" type="button">Save</button>
              <select id="loadSelect" title="Saved worlds"></select>
              <button id="loadBtn" type="button">Load</button>
              <span class="pill">BDI Planner</span>
            </div>
          </div>
        </section>
      </div>

      <div class="row-below">
        <section class="card">
          <h3>Information Panel</h3>
          <div class="card-body">
            <div class="info-grid">
              <div class="info-tile">
                <div class="info-label">Goal State</div>
                <div id="info-goal" class="info-content">—</div>
              </div>
              <div class="info-tile">
                <div class="info-label">Current Configuration</div>
                <div id="info-current" class="info-content">—</div>
              </div>
            </div>
          </div>
        </section>

        <section class="card action-tower-card">
          <h3>Action Tower</h3>
          <div class="card-body card-body-flex">
            <div id="actionLog" class="log"></div>
          </div>
        </section>

        <section class="card">
          <h3>Intention Timeline</h3>
          <div class="card-body">
            <div class="timeline-clock">
              <span class="timeline-clock-label">Elapsed</span>
              <span id="plannerClock" class="clock-display">--:--</span>
            </div>
            <div id="intentionTimeline" class="timeline"></div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script src="config.js"></script>
  <script src="script.js" defer></script>
  <script>
    // Authentication guard - redirect to login if not authenticated
    (function checkAuth() {
      const userId = localStorage.getItem('userId');
      const username = localStorage.getItem('username');
      
      if (!userId) {
        window.location.href = window.APP_CONFIG?.AUTH?.LOGIN_PAGE || 'login.html';
        return;
      }
      
      // Update user pill with username
      const userPill = document.getElementById('userPill');
      const profileMenuUsername = document.getElementById('profileMenuUsername');
      if (userPill && username) {
        userPill.textContent = username;
      }
      if (profileMenuUsername && username) {
        profileMenuUsername.textContent = username;
      }
    })();

    // Profile dropdown functionality
    (function() {
      const profileBtn = document.getElementById('profileBtn');
      const profileMenu = document.getElementById('profileMenu');
      
      if (!profileBtn || !profileMenu) return;
      
      // Toggle dropdown on button click
      profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileMenu.classList.toggle('active');
      });
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
          profileMenu.classList.remove('active');
        }
      });
      
      // Close dropdown when clicking menu items
      const menuItems = profileMenu.querySelectorAll('.profile-menu-item');
      menuItems.forEach(item => {
        item.addEventListener('click', () => {
          profileMenu.classList.remove('active');
        });
      });
    })();    // Logout function
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('userId');
        localStorage.removeItem('username');
        window.location.href = window.APP_CONFIG?.AUTH?.LOGIN_PAGE || 'login.html';
      }
    }

    (function () {
      const log = document.getElementById('actionLog');
      const infoGoal = document.getElementById('info-goal');
      const infoCur = document.getElementById('info-current');

      const startBtn = document.getElementById('startBtn');
      const goalInput = document.getElementById('goalInput');
      const worldElem = document.getElementById('world');

      window.addEventListener('load', () => {
        // Set brand names from config
        const appName = window.APP_CONFIG?.APP_NAME || 'BDI Blocks World';
        const mobileBrand = document.getElementById('mobileBrand');
        const mobileMenuBrand = document.getElementById('mobileMenuBrand');
        const sidebarBrand = document.getElementById('sidebarBrand');
        if (mobileBrand) mobileBrand.textContent = appName;
        if (mobileMenuBrand) mobileMenuBrand.textContent = appName;
        if (sidebarBrand) sidebarBrand.textContent = appName;

        const username = localStorage.getItem('username');
        const userMini = document.querySelector('.user-mini .pill');
        if (username && userMini) {
          userMini.textContent = `Signed in as ${username}`;
        }

        refreshLoadList();
      });
      window._logMove = function (txt) {
        if (!log) return;
        const p = document.createElement('div');
        p.textContent = txt;
        log.appendChild(p);
        log.scrollTop = log.scrollHeight;
      };

      // Update Current Configuration display
      function updateCurrentConfiguration() {
        if (window.world && Array.isArray(window.world.stacks)) {
          // Use formatWorldState if available, otherwise fallback to inline format
          if (typeof formatWorldState === 'function') {
            infoCur.textContent = formatWorldState(window.world.stacks);
          } else {
            infoCur.textContent = window.world.stacks.map(s => '(' + s.join(', ') + ')').join(' ');
          }
        } else {
          infoCur.textContent = '—';
        }
      }

      // Update immediately on load and periodically
      setInterval(updateCurrentConfiguration, 200);

      // Also expose for manual updates
      window.updateCurrentConfiguration = updateCurrentConfiguration;

      startBtn?.addEventListener('click', () => {
        const g = goalInput.value.trim();
        if (g) infoGoal.textContent = '(' + g.split(/\s*on\s*/i).join(', ') + ')';
      });
    })();

    // Mobile Menu Functionality
    (function () {
      const mobileMenuToggle = document.getElementById('mobileMenuToggle');
      const mobileMenu = document.getElementById('mobileMenu');
      const mobileOverlay = document.getElementById('mobileOverlay');
      const mobileMenuClose = document.getElementById('mobileMenuClose');

      function openMobileMenu() {
        mobileMenu.classList.add('active');
        mobileOverlay.classList.add('active');
        mobileMenuToggle.classList.add('active');
        document.body.style.overflow = 'hidden'; // Prevent background scrolling
      }

      function closeMobileMenu() {
        mobileMenu.classList.remove('active');
        mobileOverlay.classList.remove('active');
        mobileMenuToggle.classList.remove('active');
        document.body.style.overflow = ''; // Restore scrolling
      }

      // Toggle menu when hamburger is clicked
      mobileMenuToggle?.addEventListener('click', openMobileMenu);

      // Close menu when close button is clicked
      mobileMenuClose?.addEventListener('click', closeMobileMenu);

      // Close menu when overlay is clicked
      mobileOverlay?.addEventListener('click', closeMobileMenu);

      // Close menu when clicking a nav link
      const mobileNavLinks = mobileMenu?.querySelectorAll('.nav a');
      mobileNavLinks?.forEach(link => {
        link.addEventListener('click', () => {
          setTimeout(closeMobileMenu, 100); // Small delay to allow action to complete
        });
      });

      // Close menu on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileMenu.classList.contains('active')) {
          closeMobileMenu();
        }
      });

      // Handle window resize - close mobile menu if switching to desktop view
      window.addEventListener('resize', () => {
        if (window.innerWidth >= 768 && mobileMenu.classList.contains('active')) {
          closeMobileMenu();
        }
      });
    })();

    // Page Navigation
    (function () {
      const pageTitle = document.getElementById('pageTitle');
      const pageNavItems = document.querySelectorAll('.page-nav-item');

      pageNavItems.forEach(item => {
        item.addEventListener('click', (e) => {
          e.preventDefault();

          // Update active state
          pageNavItems.forEach(nav => nav.classList.remove('active'));
          item.classList.add('active');

          // Update page title
          const page = item.dataset.page;
          const titles = {
            'simulation': 'Simulation',
            'agent-logs': 'Agent Logs',
            'import-export': 'Import/Export',
            'profile': 'Profile'
          };
          if (pageTitle) pageTitle.textContent = titles[page] || 'Simulation';

          // Close mobile menu if open
          const mobileMenu = document.getElementById('mobileMenu');
          if (mobileMenu && mobileMenu.classList.contains('active')) {
            document.getElementById('mobileMenuClose')?.click();
          }

          // TODO: Handle actual page content switching when other pages are implemented
          if (page !== 'simulation') {
            alert(`${titles[page]} page - Coming soon!`);
          }
        });
      });
    })();
  </script>
</body>

</html>