<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title id="pageTitle">BDI Blocks World - Debug</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body>
  <main class="auth-wrapper">
    <section class="auth-card">
      <h1 id="debugHeader">Debug Page</h1>
      <p>This page is for testing backend endpoints.</p>
      
      <div class="debug-buttons">
        <button onclick="testUserSignup()">Test User Signup</button>
        <button onclick="testUserLogin()">Test User Login</button>
        <button onclick="testWorldSave()">Test World Save</button>
        <button onclick="testWorldLoad()">Test World Load</button>
        <button onclick="checkLocalStorage()">Check LocalStorage</button>
      </div>

      <div id="output" class="debug-output"></div>
    </section>
  </main>
  
  <script src="config.js"></script>
  <script>
    // Set page title and header from config
    window.addEventListener('DOMContentLoaded', () => {
      const appName = window.APP_CONFIG?.APP_NAME || 'BDI Blocks World';
      const pageTitle = document.getElementById('pageTitle');
      const debugHeader = document.getElementById('debugHeader');
      if (pageTitle) pageTitle.textContent = `${appName} - Debug`;
      if (debugHeader) debugHeader.textContent = `${appName} Debug Page`;
    });

    const output = document.getElementById('output');
    
    function log(message) {
      console.log(message);
      output.innerHTML += `<p>${message}</p>`;
    }
    
    function checkLocalStorage() {
      log('=== LocalStorage Check ===');
      log('userId: ' + localStorage.getItem('userId'));
      log('username: ' + localStorage.getItem('username'));
      log('API_BASE: ' + (window.APP_CONFIG?.API_BASE || 'undefined'));
    }
    
    async function testUserSignup() {
      log('=== Testing User Signup ===');
      const testUser = {
        email: 'test@example.com',
        username: 'testuser123',
        password: 'password123'
      };
      
      try {
        const res = await fetch(`${window.APP_CONFIG.API_BASE}/users/signup`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testUser)
        });
        
        const data = await res.json();
        log('Signup response: ' + JSON.stringify(data, null, 2));
        
        if (res.ok && data.userId) {
          localStorage.setItem('userId', data.userId);
          localStorage.setItem('username', testUser.username);
          log('✅ Signup successful, stored in localStorage');
        } else {
          log('❌ Signup failed: ' + data.message);
        }
      } catch (e) {
        log('❌ Signup error: ' + e.message);
      }
    }
    
    async function testUserLogin() {
      log('=== Testing User Login ===');
      const testUser = {
        username: 'testuser123',
        password: 'password123'
      };
      
      try {
        const res = await fetch(`${window.APP_CONFIG.API_BASE}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testUser)
        });
        
        const data = await res.json();
        log('Login response: ' + JSON.stringify(data, null, 2));
        
        if (res.ok && data.userId) {
          localStorage.setItem('userId', data.userId);
          localStorage.setItem('username', data.username);
          log('✅ Login successful, stored in localStorage');
        } else {
          log('❌ Login failed: ' + data.message);
        }
      } catch (e) {
        log('❌ Login error: ' + e.message);
      }
    }
    
    async function testWorldSave() {
      log('=== Testing World Save ===');
      const userId = localStorage.getItem('userId');
      if (!userId) {
        log('❌ No userId found, please login first');
        return;
      }
      
      const testWorld = {
        name: 'Debug Test World',
        blocks: ['A', 'B'],
        stacks: [['A'], ['B']],
        userId: userId
      };
      
      try {
        const res = await fetch(`${window.APP_CONFIG.API_BASE}/worlds`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(testWorld)
        });
        
        const data = await res.json();
        log('Save response status: ' + res.status);
        log('Save response: ' + JSON.stringify(data, null, 2));
        
        if (res.ok) {
          log('✅ World saved successfully');
        } else {
          log('❌ World save failed: ' + data.message);
        }
      } catch (e) {
        log('❌ Save error: ' + e.message);
      }
    }
    
    async function testWorldLoad() {
      log('=== Testing World Load ===');
      const userId = localStorage.getItem('userId');
      if (!userId) {
        log('❌ No userId found, please login first');
        return;
      }
      
      try {
        const res = await fetch(`${window.APP_CONFIG.API_BASE}/worlds?userId=${userId}`);
        
        const data = await res.json();
        log('Load response status: ' + res.status);
        log('Load response: ' + JSON.stringify(data, null, 2));
        
        if (res.ok) {
          log('✅ Worlds loaded successfully, found: ' + data.length);
        } else {
          log('❌ World load failed: ' + data.message);
        }
      } catch (e) {
        log('❌ Load error: ' + e.message);
      }
    }
    
    // Auto-check localStorage on load
    checkLocalStorage();
  </script>
</body>
</html>