<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard</title>
  <link rel="icon" type="image/x-icon" href="/img/logo.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="styles/main.css">
</head>
<body>
  <!-- Mobile Header -->
  <div class="mobile-header">
    <button class="hamburger" id="mobileMenuToggle" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="mobileMenu">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </button>
    <div class="mobile-brand">
      <img src="img/logo.svg" alt="BDI Blocks World logo" class="mobile-brand-logo">
      <span class="mobile-brand-text" id="mobileBrandText">BDI Blocks World</span>
    </div>
    <div class="mobile-header-spacer" aria-hidden="true"></div>
  </div>

  <!-- Mobile Overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>

  <!-- Mobile Menu -->
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-menu-header">
      <div class="mobile-menu-brand">
        <img src="img/logo.svg" alt="BDI Blocks World logo" class="mobile-menu-brand-logo">
        <span class="mobile-menu-brand-text" id="mobileMenuBrandText">BDI Blocks World</span>
      </div>
      <button class="mobile-menu-close" id="mobileMenuClose" aria-label="Close menu">&times;</button>
    </div>

    <nav class="mobile-menu-nav" aria-label="Primary">
      <a class="mobile-menu-link" data-route="dashboard" href="index.html" aria-label="Dashboard">
        <span class="material-icons mobile-menu-icon" aria-hidden="true">dashboard</span>
        <span class="mobile-menu-label">Dashboard</span>
      </a>
      <a class="mobile-menu-link admin-nav-link is-hidden" data-route="admin" href="admin.html" aria-label="Admin Dashboard">
        <span class="material-icons mobile-menu-icon" aria-hidden="true">admin_panel_settings</span>
        <span class="mobile-menu-label">Admin Dashboard</span>
      </a>
      <a class="mobile-menu-link" data-route="agent-logs" data-disabled="true" href="#" title="Coming soon" aria-label="Agent Logs">
        <span class="material-icons mobile-menu-icon" aria-hidden="true">receipt_long</span>
        <span class="mobile-menu-label">Agent Logs</span>
      </a>
      <a class="mobile-menu-link" data-route="import-export" data-disabled="true" href="#" title="Coming soon" aria-label="Import/Export">
        <span class="material-icons mobile-menu-icon" aria-hidden="true">import_export</span>
        <span class="mobile-menu-label">Import/Export</span>
      </a>
    </nav>

    <div class="mobile-menu-help">
      <div class="mobile-menu-help-header">
        <span class="material-icons" aria-hidden="true">help_outline</span>
        <strong>Admin Tips</strong>
      </div>
      <ul class="mobile-menu-help-list">
        <li>Review all registered users</li>
        <li>Promote trusted collaborators</li>
        <li>Downgrade or remove problematic accounts</li>
        <li>Changes apply immediately</li>
      </ul>
    </div>
  </div>

  <div class="app">
    <aside class="sidebar" id="sidebar" data-collapsed="false">
      <div class="sidebar__inner">
        <div class="sidebar__header">
          <img src="img/logo.svg" alt="BDI Blocks World logo" class="sidebar__logo">
          <span class="sidebar__title" id="sidebarTitle">BDI Blocks World</span>
        </div>

        <nav class="sidebar__nav" aria-label="Primary">
          <a class="sidebar__link" data-route="dashboard" href="index.html" title="Dashboard" aria-label="Dashboard">
            <span class="material-icons sidebar__icon" aria-hidden="true">dashboard</span>
            <span class="sidebar__label">Dashboard</span>
          </a>
          <a class="sidebar__link admin-nav-link is-hidden" data-route="admin" href="admin.html" title="Admin Dashboard" aria-label="Admin Dashboard">
            <span class="material-icons sidebar__icon" aria-hidden="true">admin_panel_settings</span>
            <span class="sidebar__label">Admin Dashboard</span>
          </a>
          <a class="sidebar__link" data-route="agent-logs" data-disabled="true" href="#" title="Agent logs coming soon" aria-label="Agent Logs">
            <span class="material-icons sidebar__icon" aria-hidden="true">receipt_long</span>
            <span class="sidebar__label">Agent Logs</span>
          </a>
          <a class="sidebar__link" data-route="import-export" data-disabled="true" href="#" title="Import/export coming soon" aria-label="Import/Export">
            <span class="material-icons sidebar__icon" aria-hidden="true">import_export</span>
            <span class="sidebar__label">Import/Export</span>
          </a>
        </nav>

        <div class="sidebar__help">
          <span class="material-icons sidebar__help-icon" aria-hidden="true">help_outline</span>
          <div class="sidebar__help-content">
            <strong class="sidebar__help-title">Admin Tips</strong>
            <ul class="sidebar__help-list">
              <li>Review user roles regularly</li>
              <li>Promote reliable collaborators</li>
              <li>Demote inactive administrators</li>
              <li>Delete accounts when necessary</li>
            </ul>
          </div>
        </div>
      </div>

      <button class="sidebar__toggle" id="sidebarToggle" type="button" aria-label="Collapse navigation" aria-expanded="true">
        <span class="material-icons sidebar__toggle-icon" id="sidebarToggleIcon" aria-hidden="true">chevron_left</span>
        <span class="sidebar__toggle-text">Collapse</span>
      </button>
    </aside>

    <main class="main admin-container">
      <section class="hero">
        <div class="hero-header">
          <h2 class="hero-title">Admin Dashboard</h2>
          <div class="profile-dropdown">
            <button class="profile-btn" id="profileBtn" aria-label="Profile menu" aria-expanded="false">
              <span class="material-icons profile-icon">account_circle</span>
              <span class="profile-name" id="profileName">Admin</span>
              <span class="material-icons profile-arrow">expand_more</span>
            </button>
            <div class="profile-menu" id="profileMenu">
              <div id="profileMenuLoggedIn" style="display:none;">
                <a href="#" class="profile-menu-item" id="viewProfile">
                  <span class="material-icons">person</span>
                  <span>Profile</span>
                </a>
                <a href="admin.html" class="profile-menu-item" id="adminMenuItem" style="display:none;">
                  <span class="material-icons">admin_panel_settings</span>
                  <span>Admin Dashboard</span>
                </a>
                <a href="#" class="profile-menu-item" onclick="logout(); return false;">
                  <span class="material-icons">logout</span>
                  <span>Logout</span>
                </a>
              </div>
              <div id="profileMenuLoggedOut">
                <a href="login.html" class="profile-menu-item">
                  <span class="material-icons">login</span>
                  <span>Sign In</span>
                </a>
                <a href="signup.html" class="profile-menu-item">
                  <span class="material-icons">person_add</span>
                  <span>Register</span>
                </a>
              </div>
            </div>
          </div>
        </div>
      </section>

      <p id="status" class="admin-status">Loading...</p>

      <table class="admin-table">
        <thead>
          <tr>
            <th>Username</th>
            <th>Email</th>
            <th>Role</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="users"></tbody>
      </table>
    </main>
  </div>

  <script src="config.js"></script>
  <script type="module">
    import { requireAdmin, logout as authLogout, authenticatedFetch, updateUIWithUserInfo } from './utils/auth.js';
    import { initializeMobileNavigation, initializeSidebarNavigation } from './utils/navigation.js';
    import { initializeProfileMenu } from './utils/profile.js';

    requireAdmin();
    window.logout = authLogout;

    const statusEl = document.getElementById('status');
    const rows = document.getElementById('users');

    async function api(path, opts = {}) {
      const res = await authenticatedFetch(path, opts);
      if (!res.ok) throw new Error(await res.text());
      return res.json();
    }

    async function loadUsers() {
      try {
        statusEl.textContent = 'Loading users...';
        const list = await api('/admin/users');
        rows.innerHTML = '';
        list.forEach(user => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${user.username}</td>
            <td>${user.email}</td>
            <td>${user.role}</td>
            <td>
              ${user.role !== 'admin' ? `<button class="action" onclick="promote('${user._id}')">Promote</button>` : ''}
              ${user.role === 'admin' ? `<button class="action" onclick="demote('${user._id}')">Demote</button>` : ''}
              <button class="action" onclick="removeUser('${user._id}')">Delete</button>
            </td>`;
          rows.appendChild(tr);
        });
        statusEl.textContent = 'âœ… Users loaded.';
      } catch (error) {
        statusEl.textContent = 'Error: ' + error.message;
      }
    }

    async function promote(id) {
      await api(`/admin/users/${id}/promote`, { method: 'POST' });
      loadUsers();
    }

    async function demote(id) {
      await api(`/admin/users/${id}/demote`, { method: 'POST' });
      loadUsers();
    }

    async function removeUser(id) {
      await api(`/admin/users/${id}`, { method: 'DELETE' });
      loadUsers();
    }

    function applyBranding() {
      const appName = window.APP_CONFIG?.APP_NAME || 'BDI Blocks World';
      const mobileBrand = document.getElementById('mobileBrandText');
      const mobileMenuBrand = document.getElementById('mobileMenuBrandText');
      const sidebarBrand = document.getElementById('sidebarTitle');

      if (mobileBrand) mobileBrand.textContent = appName;
      if (mobileMenuBrand) mobileMenuBrand.textContent = appName;
      if (sidebarBrand) sidebarBrand.textContent = appName;
    }

    initializeMobileNavigation();
    initializeSidebarNavigation({ storageKey: 'bdiAdminSidebarCollapsed', activeRoute: 'admin' });
    initializeProfileMenu();
    applyBranding();
    updateUIWithUserInfo({ adminNav: '.admin-nav-link' });

    window.promote = promote;
    window.demote = demote;
    window.removeUser = removeUser;

    loadUsers();
  </script>
</body>
</html>
